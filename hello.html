<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Document</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        .carousel {
            width: 100%; /* Set the desired width */
            height: 400px; /* Set the desired height */
        }
        .carousel-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body>
    <img src="Blaz.jpg" alt="Une belle photo">
    <main>
        <header>
            <?php require('header.php'); ?>
        </header>
        <div class="main-content">
            <div class="extra-left-column">
                <h2>INFOS ECE</h2>
                <div>
                    <?php
                        require('databaseinfosece.php');
                        foreach ($_SESSION['infosece'] as $info) {
                            echo '<div class="info">';
                            echo '<h3>' . htmlspecialchars($info['titre'], ENT_QUOTES, 'UTF-8') . '</h3>';
                            echo '<p>' . htmlspecialchars($info['contenu'], ENT_QUOTES, 'UTF-8') . '</p>';
                            echo '</div>';
                        }
                    ?>
                </div>
            </div>
            <div class="left-column">
                <form action="databasetweet.php" method="POST">
                    <input type="hidden" name="form" value="publication">
                    <label for="publication">Poster un tweet</label>
                    <input type="text" name="publication" id="publication">
                    <button type="submit">Tweeter</button>
                </form>
                <div>
                    <?php
                        require('databasetweet.php');
                        foreach ($tweets as $tweet) {
                            foreach ($users as $user) {
                                if ($user['ID_Utilisateur'] == $tweet['ID_Utilisateur']) {
                                    echo '
                                        <section>
                                            <div>
                                                <h2>' . $user['Pseudo'] . '</h2>
                                            </div>
                                            <div class="tweet">' . $tweet['Titre'] . '</div>
                                            <div class="tweet">' . $tweet['Contenu'] . '</div>
                                        </section>';
                                }
                            }
                        }
                    ?>
                </div>


                <h2 class="mt-4">Merci à notre Sponsor !</h2>
                    
                    <div id="carouselExampleDark" class="carousel carousel-dark slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            <div class="carousel-item active" data-bs-interval="4000">
                                <a href="https://www.coca-cola.com/fr/fr">
                                    <img src="COCA.jpg" >
                                </a>
                                
                            </div>
                            <div class="carousel-item" data-bs-interval="4000">
                                <a href="https://www.coca-cola.com/fr/fr">
                                    <img src="COCA2.jpg">
                                </a>
                                
                            </div>
                            <div class="carousel-item" data-bs-interval="4000">
                                <a href="https://www.coca-cola.com/fr/fr">
                                    <img src="COCA3.jpg">
                                </a>
                                
                            </div>
                            <div class="carousel-item" data-bs-interval="4000">
                                <a href="https://www.coca-cola.com/fr/fr">
                                    <img src="COCA4.jpg">
                                </a>
                                
                            </div>
                            <div class="carousel-item" data-bs-interval="4000">
                                <a href="https://www.coca-cola.com/fr/fr">
                                    <img src="COCA5.jpg">
                                </a>
                                
                            </div>
                        </div>
                        
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>

                <h5 class="mt-4">Profitez de réductions exclusives ! Jusqu'à 30%, 40%, 50% !</h5>



            </div>








            <div class="right-column">
                <h2>Actualites</h2>
                <div>
                    <?php
                        require('databaseactualites.php');
                        foreach ($_SESSION['actualites'] as $actualite) {
                            echo '<div class="actualite">';
                            echo '<h3>' . htmlspecialchars($actualite['titre'], ENT_QUOTES, 'UTF-8') . '</h3>';
                            echo '<p>' . htmlspecialchars($actualite['contenu'], ENT_QUOTES, 'UTF-8') . '</p>';
                            echo '</div>';
                        }
                    ?>
                </div>
                <h2 class="mt-4">Evénement de la Semaine :</h2>
                    <h5 class="mt-4">Journée portes ouvertes à l'ECE Paris le mardi 4 Juin !</h5>
                    <div id="carouselExampleDark" class="carousel carousel-dark slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            <div class="carousel-item active" data-bs-interval="5000">
                                <img src="EM009.jpg" >
                                
                            </div>
                            <div class="carousel-item" data-bs-interval="5000">
                                <img src="paris.jpg" >
                                
                            </div>
                            <div class="carousel-item" data-bs-interval="5000">
                                <img src="dehors.jpg" >
                                
                            </div>
                        </div>
                        
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
            </div>
        </div>
    </main>


    
    <footer>
        <iframe
          width="600"
          height="450"
          style="border:0"
          loading="lazy"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade"
          src="https://www.google.com/maps/embed/v1/place?key=AIzaSyAT-LvaBsU6SYd9KYmXnmZUutzTyzrrwGA
            &q=Space+Needle,Seattle+WA">
        </iframe>
    </footer>



    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
</body>
</html>

<?php
session_start();
if (!isset($_SESSION['pseudo'])) {
    header("Location: index.php");
    exit();
}

$servername = "localhost";
$username = "root";
$password = "";
$dbname = "twitterlike";

$conn = new mysqli($servername, $username, $password, $dbname);

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

$pseudo = $_SESSION['pseudo'];
$userIdQuery = "SELECT ID_Utilisateur FROM utilisateur WHERE Pseudo='$pseudo'";
$userIdResult = $conn->query($userIdQuery);
$userIdRow = $userIdResult->fetch_assoc();
$userId = $userIdRow['ID_Utilisateur'];

// Récupérer les groupes de l'utilisateur
$groupsQuery = "
    SELECT g.ID_Groupe, g.Nom_Groupe 
    FROM Groupe g 
    JOIN Groupe_Utilisateur gu ON g.ID_Groupe = gu.ID_Groupe 
    WHERE gu.ID_Utilisateur = $userId";
$groupsResult = $conn->query($groupsQuery);

?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messagerie ECE In</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 30%;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        .chat {
            width: 70%;
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        .message {
            background: #e9e9e9;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .header {
            background: #fff;
            padding: 10px;
            width: 100%;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group {
            padding: 10px;
            margin: 10px 0;
            background: #e9e9e9;
            border-radius: 5px;
            cursor: pointer;
        }
        .group:hover {
            background: #dcdcdc;
        }
        .group-form {
            margin-bottom: 20px;
        }
        .group-form input, .group-form button {
            width: calc(100% - 22px);
            padding: 10px;
            margin: 5px 0;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<header>
        <?php require('header.php'); ?>
    </header>
    <div class="sidebar">
        <div class="header">
            <div>Bienvenue, <?php echo htmlspecialchars($pseudo); ?></div>
            <div>
                <a href="logout.php">Se déconnecter</a>
                <a href="index.php">Retour</a>
            </div>
        </div>
        <div class="group-form">
            <h3>Créer un groupe</h3>
            <form id="createGroupForm" action="create_group.php" method="POST">
                <input type="text" name="group_name" placeholder="Nom du groupe" required>
                <label for="number_of_users">Nombre d'utilisateurs (2-4):</label>
                <select id="number_of_users" name="number_of_users" required>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
                <div id="additional_users">
                    <!-- Les champs pour les utilisateurs supplémentaires seront ajoutés ici -->
                    <input type="text" name="user_2" placeholder="Pseudo utilisateur 2">
                </div>
                <button type="submit">Créer</button>
            </form>
        </div>
        <div class="groups">
            <h3>Vos groupes</h3>
            <?php
            if ($groupsResult->num_rows > 0) {
                while($groupRow = $groupsResult->fetch_assoc()) {
                    echo "<div class='group' data-group-id='" . $groupRow['ID_Groupe'] . "'>" . htmlspecialchars($groupRow['Nom_Groupe']) . "</div>";
                }
            } else {
                echo "Aucun groupe.";
            }
            ?>
        </div>
    </div>
    <div class="chat">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages seront chargés ici -->
        </div>
        <form id="messageForm" style="display: none;">
            <textarea name="message" id="messageInput" placeholder="Tapez votre message ici..." required></textarea>
            <button type="submit">Envoyer</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.group').forEach(function(groupElement) {
                groupElement.addEventListener('click', function() {
                    const groupId = this.getAttribute('data-group-id');
                    fetchMessages(groupId);
                    document.getElementById('messageForm').style.display = 'block';
                    document.getElementById('messageForm').setAttribute('data-group-id', groupId);
                });
            });

            document.getElementById('messageForm').addEventListener('submit', function(event) {
                event.preventDefault();
                const groupId = this.getAttribute('data-group-id');
                const message = document.getElementById('messageInput').value;
                sendMessage(groupId, message);
            });

            document.getElementById('number_of_users').addEventListener('change', function() {
                const numberOfUsers = this.value;
                const additionalUsersContainer = document.getElementById('additional_users');
                additionalUsersContainer.innerHTML = '';
                for (let i = 1; i < numberOfUsers; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = `user_${i}`;
                    input.placeholder = `Pseudo utilisateur ${i}`;
                    input.required = true;
                    additionalUsersContainer.appendChild(input);
                }
            });

            function fetchMessages(groupId) {
                fetch(`fetch_messages.php?group_id=${groupId}`)
                    .then(response => response.json())
                    .then(data => {
                        const chatMessages = document.getElementById('chatMessages');
                        chatMessages.innerHTML = '';
                        data.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.className = 'message';
                            msgDiv.innerHTML = `<strong>${msg.Pseudo}:</strong> ${msg.Contenu} <br> <small>${msg.Date_Message}</small>`;
                            chatMessages.appendChild(msgDiv);
                        });
                    });
            }

            function sendMessage(groupId, message) {
                fetch('send_message.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        group_id: groupId,
                        message: message
                    })
                }).then(() => {
                    document.getElementById('messageInput').value = '';
                    fetchMessages(groupId);
                });
            }
        });
    </script>
</body>
</html>
